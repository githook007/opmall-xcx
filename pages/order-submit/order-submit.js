(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/order-submit/order-submit"],{"39fe":function(t,e,i){"use strict";i.r(e);var o=i("f093"),r=i("c0e3");for(var a in r)"default"!==a&&function(t){i.d(e,t,function(){return r[t]})}(a);i("57f9");var s=i("2877"),n=Object(s["a"])(r["default"],o["a"],o["b"],!1,null,"03780402",null);e["default"]=n.exports},"508c":function(t,e,i){},"57f9":function(t,e,i){"use strict";i("508c")},"718c":function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=i("2f62");function r(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function a(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?r(i,!0).forEach(function(e){s(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):r(i).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function s(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var n=function(){return i.e("components/page-component/app-diy-form/app-diy-form").then(i.bind(null,"7d93"))},l=function(){return Promise.all([i.e("common/vendor"),i.e("pages/order-submit/app-submit-goods")]).then(i.bind(null,"92a5"))},u=function(){return i.e("pages/order-submit/app-coupon-pick").then(i.bind(null,"3a57"))},c=function(){return i.e("pages/order-submit/app-bottom-modal").then(i.bind(null,"9421"))},d=function(){return i.e("pages/order-submit/app-address-bar").then(i.bind(null,"e047"))},h=function(){return Promise.all([i.e("common/vendor"),i.e("pages/order-submit/order-address")]).then(i.bind(null,"a82a"))},m=function(){return i.e("pages/order-submit/app-submit-checkbox").then(i.bind(null,"4e22"))},p=function(){return i.e("components/basic-component/app-close/app-close").then(i.bind(null,"f0dd"))},f={name:"order-submit",components:{AppSubmitCheckbox:m,AppAddressBar:d,AppBottomModal:c,AppCouponPick:u,AppDiyForm:n,appSubmitGoods:l,AppClose:p,AppOrderAddress:h},data:function(){return{totalTitle:"合计",check:!1,previewData:{mch_list:[],total_price:0,vip_card_discount_total_price:null,custom_currency_all:[]},getLocationFail:!1,previewUrl:null,submitUrl:null,plugin:null,orderPageUrl:null,submitLock:!1,getPayDataTimer:null,userTheme:null,is_gift:!1,payDataUrl:null,showPayResult:!0,payCancelUrl:null,loadingPreviewData:!0,showClose:!1,is_open:!1,mchList:"",p_pay_id:"",invoice:{},invoiceType:null}},computed:a({},(0,o.mapState)({appImg:function(t){return t.mallConfig.__wxapp_img},appConfig:function(t){return t.mallConfig}}),{theme:function(){return this.userTheme?this.userTheme:this.getTheme}},(0,o.mapGetters)("mallConfig",{getTheme:"getTheme"}),{themeBgClass:function(){if(this.userTheme&&this.userTheme.indexOf("gift")>=0)return"".concat(this.theme," ").concat(this.theme,"-background")},themeTextClass:function(){if(this.userTheme&&this.userTheme.indexOf("gift")>=0)return"".concat(this.theme," ").concat(this.theme,"-color")}}),onLoad:function(t){var e=this;this.$commonLoad.onload(t),this.invoiceType=this.appConfig.invoice;var i=JSON.parse(t.mch_list),o=[],r=!0,a=!1,s=void 0;try{for(var n,l=i[Symbol.iterator]();!(r=(n=l.next()).done);r=!0){var u=n.value;u.mch_id>0&&o.push(u.mch_id)}}catch(c){a=!0,s=c}finally{try{r||null==l.return||l.return()}finally{if(a)throw s}}this.is_gift=!!(this.userTheme&&this.userTheme.indexOf("gift")>=0),this.mchList=o.length>0?JSON.stringify(o):"0",this.submitLock||(this.setFormData(t),this.$event.on(this.$const.EVENT_USER_LOGIN).then(function(){e.loadPreviewData()}))},onShow:function(){var e=this;this.showClose=!1,setTimeout(function(){e.showClose=!0,console.log(e.$refs.address),e.$refs.address.refresh()}),t.$on("invoices",function(i){e.invoice=JSON.parse(i.invoices),t.$off("invoices")})},onUnload:function(){this.getPayDataTimer&&clearTimeout(this.getPayDataTimer)},watch:{"previewData.address.name":{handler:function(){this.changeZitiAddress()}},"previewData.address.mobile":{handler:function(){this.changeZitiAddress()}}},methods:{getMall:function(t){if(console.log(t),void 0!=t&&(this.is_open=!(!t||1!=t.is_open),this.is_open)){if(this.submitLock)return;this.loadPreviewData()}},noCouponStatus:function(t){var e=this.$store.getters["orderSubmit/getMchNoCouponStatusList"];return!!e[t]},navigateVipCardPrivilege:function(){t.navigateTo({url:"/plugins/vip_card/rights/rights?id=1"})},showCouponPicker:function(t){this.previewData.mch_list[t].showCouponPicker=!0},reversalShowInsertRows:function(t){this.previewData.mch_list[t].showInsertRows=!this.previewData.mch_list[t].showInsertRows},updateList:function(t,e){this.previewData.mch_list[e]=t,this.$forceUpdate()},setParams:function(t){t.total_title&&(this.totalTitle=t.total_title)},handleOrderFormInput:function(t){var e=t.data,i=t.sign,o=[];for(var r in e)o[r]={key:e[r].key,label:e[r].name,value:e[r].value,required:e[r].is_required};var a=this.$store.state.orderSubmit.formData;a.list[i].order_form=o,this.$store.commit("orderSubmit/mutSetFormData",a)},handleOrderFormValidate:function(t){var e=t.result,i=t.sign,o=this.$store.state.orderSubmit.formData;o.list[i].order_form_validate_result=e,this.$store.commit("orderSubmit/mutSetFormData",o)},setFormData:function(t){this.previewUrl=decodeURIComponent(t.preview_url||this.$api.order.preview),this.submitUrl=decodeURIComponent(t.submit_url||this.$api.order.submit),this.plugin=t.plugin||null,this.orderPageUrl=decodeURIComponent(t.order_page_url||"/pages/order/index/index?status=0"),this.userTheme=t.theme||null,this.payDataUrl=decodeURIComponent(t.pay_data_url||this.$api.order.pay_data),this.payCancelUrl=t.pay_cancel_url?decodeURIComponent(t.pay_cancel_url):null,this.showPayResult=t.show_pay_result||!0,"true"===this.showPayResult&&(this.showPayResult=!0),"false"===this.showPayResult&&(this.showPayResult=!1);var e=JSON.parse(t.mch_list);for(var i in e)if(0===parseInt(e[i].mch_id)){var o=e[i];e.splice(i,1),e.unshift(o);break}for(var r in e){for(var a in e[r].distance=0,e[r].remark="",e[r].order_form=[],e[r].use_integral=0,e[r].user_coupon_id=0,e[r].goods_list)e[r].goods_list[a].cart_id=e[r].goods_list[a].cart_id||0;if("booking"===this.plugin){var s=this.bookStorage("get");e[r]["store_id"]=s||""}}this.$store.commit("orderSubmit/mutSetFormData",{list:e,address_id:0,send_type:t.send_type||""})},bookStorage:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i="_book_storage_order_preview";if("get"===t)return this.$storage.getStorageSync(i);"save"===t&&this.$storage.setStorageSync(i,e||0)},loadPreviewData:function(){var e=this;this.loadingPreviewData=!0,t.showLoading({mask:!0,title:"加载中"}),this.$request({url:this.previewUrl,method:"post",data:{form_data:JSON.stringify(this.$store.state.orderSubmit.formData)}}).then(function(i){if(e.loadingPreviewData=!1,t.hideLoading(),0===i.code){for(var o in i.data.allZiti&&!i.data.address&&(i.data.address={name:"",mobile:""}),i.data.mch_list)i.data.mch_list[o].showCouponPicker=!1,i.data.mch_list[o].noCoupons=!1,i.data.mch_list[o].showInsertRows=!1;e.previewData=i.data,e.setDiyFormScrollStatus(),e.checkCouponError(),e.updateStoreDistance(),e.updateGoodsCount()}else t.showModal({title:"提示",content:i.msg,showCancel:!1,success:function(){t.navigateBack()}})}).catch(function(){e.loadingPreviewData=!1,t.hideLoading()})},navigateStore:function(e){if(0==this.previewData.mch_list[e].mch.id){var i="";"booking"===this.plugin&&(i=this.previewData.mch_list[0].goods_list[0].id);var o=this.plugin||"";t.navigateTo({url:"/pages/order-submit/store-pick?mchIndex=".concat(e,"&plugin=").concat(o,"&firstGoodsId=").concat(i)})}},navigateCoupon:function(e){t.navigateTo({url:"/pages/order-submit/coupon-pick?mchIndex=".concat(e)})},navigateSvip:function(e){t.navigateTo({url:"/pages/order-submit/vip-card?mchIndex=".concat(e)})},changeZitiAddress:function(){var t=this.$store.state.orderSubmit.formData;t.address={name:this.previewData.address?this.previewData.address.name:"",mobile:this.previewData.address?this.previewData.address.mobile:""},this.$store.commit("orderSubmit/mutSetFormData",t)},changeSendType:function(t,e){if(this.previewData.mch_list[t].delivery.send_type!=e){var i=this.$store.state.orderSubmit.formData;i.list[t].send_type=e,this.$store.commit("orderSubmit/mutSetFormData",i),this.previewData.mch_list[t].delivery.send_type=e,this.loadPreviewData()}},updateStoreDistance:function(){var e=this;this.previewData&&(this.previewData.has_ziti||"booking"==this.plugin)&&t.getLocation({success:function(t){for(var i in e.previewData.mch_list)if(e.previewData.mch_list[i].store&&(!e.previewData.mch_list[i].store.distance||"-m"==e.previewData.mch_list[i].store.distance)&&""!=e.previewData.mch_list[i].store.latitude&&""!=e.previewData.mch_list[i].store.longitude&&!isNaN(e.previewData.mch_list[i].store.latitude)&&!isNaN(e.previewData.mch_list[i].store.longitude)){var o=e.$utils.earthDistance({lat:t.latitude,lng:t.longitude},{lat:e.previewData.mch_list[i].store.latitude,lng:e.previewData.mch_list[i].store.longitude}),r="-m";r=o>1e3?(o/1e3).toFixed(2)+"km":o.toFixed(0)+"m",e.previewData.mch_list[i].store.distance=r}},fail:function(){e.getLocationFail=!0}})},openLocationSetting:function(){this.getLocationFail=!1,t.openSetting({})},showIntegralTip:function(){t.showModal({title:"积分抵扣说明",content:this.$store.state.mallConfig.mall.setting.member_integral_rule,showCancel:!1})},changeIntegral:function(t){var e=this.$store.state.orderSubmit.formData,i=!this.previewData.mch_list[t].integral.use;e.list[t].use_integral=i?1:0,this.previewData.mch_list[t].integral.use=i,this.loadPreviewData()},inputRemark:function(t){var e=this.$store.state.orderSubmit.formData;e.list[t].remark=this.previewData.mch_list[t].remark,this.$store.commit("orderSubmit/mutSetFormData",e)},submit:function(){var e=this;t.showLoading({mask:!0,title:"提交中"}),this.$request({url:this.submitUrl,method:"post",data:{form_data:JSON.stringify(this.$store.state.orderSubmit.formData)}}).then(function(i){0===i.code?e.getPayOrderId(i.data.queue_id,i.data.token):(e.submitLock=!1,t.hideLoading(),t.showModal({title:"",content:i.msg,showCancel:!1}))}).catch(function(i){e.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:i.errMsg,showCancel:!1})})},getPayOrderId:function(e,i){var o=this;this.$request({url:this.payDataUrl,method:"post",data:{queue_id:e,token:i}}).then(function(r){0===r.code?r.data.retry&&1===r.data.retry?o.getPayDataTimer=setTimeout(function(){o.getPayOrderId(e,i)},1e3):(t.hideLoading(),o.pay(r.data)):(o.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:r.msg,showCancel:!1}))}).catch(function(e){o.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:e.errMsg,showCancel:!1})})},pay:function(e){var i=this;this.p_pay_id=e.id,this.$payment.pay(e.id).then(function(o){if(i.showPayResult)t.redirectTo({url:"/pages/order-submit/pay-result?payment_order_union_id=".concat(e.id,"&order_page_url=").concat(encodeURIComponent(i.orderPageUrl),"&invoice=").concat(JSON.stringify(i.invoice))});else{var r=i.orderPageUrl;-1===r.indexOf("?")?r+="?":r+="&",delete e.id,r+="pay_data=".concat(JSON.stringify(e)),t.redirectTo({url:r})}}).catch(function(o){if(i.payCancelUrl){var r=i.payCancelUrl;-1===r.indexOf("?")?r+="?":r+="&",r+="pay_data=".concat(JSON.stringify(e)),t.redirectTo({url:r})}else"5b03b6e009796c698d132908cb635fca"===o.errMsg?i.submitLock=!1:t.showModal({title:"提交失败",content:o.errMsg,showCancel:!1,success:function(){t.redirectTo({url:i.orderPageUrl})}})})},jump:function(){t.navigateTo({url:"/pages/order-submit/map"})},checkCouponError:function(){for(var e in this.previewData.mch_list)if(this.previewData.mch_list[e].coupon&&this.previewData.mch_list[e].coupon.coupon_error)return void t.showModal({title:"",content:this.previewData.mch_list[e].coupon.coupon_error,showCancel:!1})},setDiyFormScrollStatus:function(){for(var t in this.previewData.mch_list){var e=this.previewData.mch_list[t].order_form;e&&(e.value&&e.value.length&&e.value.length>=5?e.show_scroll=!0:e.show_scroll=!1)}},subscribe:function(){var e=this;if(this.p_pay_id)return this.pay({id:this.p_pay_id}),!0;for(var i in this.p_pay_id="",this.$store.state.orderSubmit.formData.list){var o=this.$store.state.orderSubmit.formData.list[i];if(o.order_form_validate_result&&o.order_form_validate_result.hasError)return void t.showModal({title:"提示",content:o.order_form_validate_result.errors[0].msg,showCancel:!1})}for(var r in this.$store.state.orderSubmit.formData.list){for(var a in this.$store.state.orderSubmit.formData.list[r].goods_list){var s=this.$store.state.orderSubmit.formData.list[r].goods_list[a];if(s.goods_form_validate_result&&s.goods_form_validate_result.hasError)return void t.showModal({title:"提示",content:s.goods_form_validate_result.errors[0].msg,showCancel:!1})}"booking"===this.plugin&&this.$store.state.orderSubmit.formData.list[r]&&this.bookStorage("save",this.$store.state.orderSubmit.formData.list[r].store_id)}this.submitLock||(this.submitLock=!0,this.$subscribe(this.previewData.template_message_list).then(function(t){e.submit()}).catch(function(){e.submit()}))},handleGoodsFormInput:function(t){var e=t.data,i=t.sign,o=i.split(","),r=parseInt(o[0]),a=parseInt(o[1]),s=[];for(var n in e)s[n]={key:e[n].key,label:e[n].name,value:e[n].value,required:e[n].is_required};var l=this.$store.state.orderSubmit.formData;l.list[r].goods_list[a].form_data=s,this.$store.commit("orderSubmit/mutSetFormData",l)},handleGoodsFormValidate:function(t){var e=t.result,i=t.sign;if(i){var o=i.split(","),r=parseInt(o[0]),a=parseInt(o[1]),s=this.$store.state.orderSubmit.formData;s.list[r].goods_list[a].goods_form_validate_result=e,this.$store.commit("orderSubmit/mutSetFormData",s)}},updateGoodsCount:function(){for(var t in this.previewData.mch_list){var e=0;for(var i in this.previewData.mch_list[t].goods_list)e+=parseInt(this.previewData.mch_list[t].goods_list[i].num);this.previewData.mch_list[t].goods_count=e}},handleAddressInput:function(t){"undefined"!==typeof t.name&&(this.previewData.address.name=t.name),"undefined"!==typeof t.mobile&&(this.previewData.address.mobile=t.mobile)},toSelectInvoiceHeader:function(){var t=this;wx.chooseInvoiceTitle({success:function(e){console.log(e),t.invoice=e}})},applys:function(e){t.navigateTo({url:"/plugins/invoice/invoice-info/invoice-info?type="+e})},handelAddressChange:function(t){}}};e.default=f}).call(this,i("543d")["default"])},ae58:function(t,e){t.exports=require("../siteinfo.js")},c0e3:function(t,e,i){"use strict";i.r(e);var o=i("718c"),r=i.n(o);for(var a in o)"default"!==a&&function(t){i.d(e,t,function(){return o[t]})}(a);e["default"]=r.a},f093:function(t,e,i){"use strict";var o=function(){var t=this,e=t.$createElement,i=(t._self._c,t.__map(t.previewData.mch_list,function(e,i){var o=t.noCouponStatus(i);return{$orig:t.__get_orig(e),m0:o}}));t.$mp.data=Object.assign({},{$root:{l0:i}})},r=[];i.d(e,"a",function(){return o}),i.d(e,"b",function(){return r})}},[["3d1c","common/runtime","common/vendor"]]]);